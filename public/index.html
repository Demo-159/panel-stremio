<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Addon de Stremio - Panel de Administraci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .addon-url {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .addon-url h3 {
            margin-bottom: 10px;
        }

        .addon-url code {
            background: rgba(255,255,255,0.3);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            word-break: break-all;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.4);
        }

        .content-list {
            margin-top: 30px;
        }

        .content-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-info {
            flex: 1;
        }

        .content-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .content-info p {
            color: #666;
            font-size: 14px;
        }

        .content-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .series-selector {
            margin-bottom: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .content-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .content-actions {
                margin-top: 15px;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Mi Addon de Stremio</h1>
            <p>Panel de administraci√≥n para gestionar tu contenido personalizado</p>
            
            <div class="addon-url">
                <h3>üîó URL del Addon para Stremio:</h3>
                <code id="addonUrl">https://tu-addon.render.com/manifest.json</code>
                <br><br>
                <small>Copia esta URL e instala el addon en Stremio</small>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Resumen</button>
            <button class="tab" onclick="showTab('movies')">üé¨ Pel√≠culas</button>
            <button class="tab" onclick="showTab('series')">üì∫ Series</button>
            <button class="tab" onclick="showTab('episodes')">üéûÔ∏è Episodios</button>
        </div>

        <!-- Tab: Resumen -->
        <div id="overview" class="tab-content active">
            <h2>üìä Estad√≠sticas del Contenido</h2>
            <div class="stats">
                <div class="stat-card">
                    <h3 id="movieCount">0</h3>
                    <p>Pel√≠culas</p>
                </div>
                <div class="stat-card">
                    <h3 id="seriesCount">0</h3>
                    <p>Series</p>
                </div>
                <div class="stat-card">
                    <h3 id="episodeCount">0</h3>
                    <p>Episodios</p>
                </div>
            </div>

            <h3>üìù Contenido Reciente</h3>
            <div id="recentContent" class="content-list">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Tab: Pel√≠culas -->
        <div id="movies" class="tab-content">
            <h2>üé¨ Gesti√≥n de Pel√≠culas</h2>
            
            <div id="movieAlert" class="alert" style="display: none;"></div>
            
            <form id="movieForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="movieId">ID de IMDB *</label>
                        <input type="text" id="movieId" placeholder="tt1234567" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="movieName">Nombre *</label>
                        <input type="text" id="movieName" placeholder="T√≠tulo de la pel√≠cula" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="movieYear">A√±o</label>
                        <input type="number" id="movieYear" placeholder="2023" min="1900" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieRuntime">Duraci√≥n (min)</label>
                        <input type="number" id="movieRuntime" placeholder="120">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieGenre">G√©neros (separados por coma)</label>
                        <input type="text" id="movieGenre" placeholder="Acci√≥n, Drama, Thriller">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieDirector">Directores (separados por coma)</label>
                        <input type="text" id="movieDirector" placeholder="Director 1, Director 2">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieCast">Reparto (separado por coma)</label>
                        <input type="text" id="movieCast" placeholder="Actor 1, Actor 2, Actor 3">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieRating">Rating IMDB</label>
                        <input type="number" id="movieRating" step="0.1" min="0" max="10" placeholder="8.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="moviePoster">URL del Poster</label>
                        <input type="url" id="moviePoster" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieBackground">URL del Fondo</label>
                        <input type="url" id="movieBackground" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieLogo">URL del Logo</label>
                        <input type="url" id="movieLogo" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="movieUrl">URL del Video *</label>
                        <input type="url" id="movieUrl" placeholder="https://..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="movieQuality">Calidad</label>
                        <select id="movieQuality">
                            <option value="">Seleccionar calidad</option>
                            <option value="HD">HD</option>
                            <option value="Full HD">Full HD</option>
                            <option value="4K">4K</option>
                            <option value="SD">SD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="movieLanguage">Idioma</label>
                        <input type="text" id="movieLanguage" placeholder="Espa√±ol" value="Espa√±ol">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="movieDescription">Descripci√≥n</label>
                        <textarea id="movieDescription" placeholder="Descripci√≥n de la pel√≠cula..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">‚ûï Agregar Pel√≠cula</button>
            </form>

            <div id="movieList" class="content-list">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Tab: Series -->
        <div id="series" class="tab-content">
            <h2>üì∫ Gesti√≥n de Series</h2>
            
            <div id="seriesAlert" class="alert" style="display: none;"></div>
            
            <form id="seriesForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="seriesId">ID de IMDB *</label>
                        <input type="text" id="seriesId" placeholder="tt1234567" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesName">Nombre *</label>
                        <input type="text" id="seriesName" placeholder="T√≠tulo de la serie" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesYear">A√±o</label>
                        <input type="number" id="seriesYear" placeholder="2023" min="1900" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesRuntime">Duraci√≥n episodio (min)</label>
                        <input type="number" id="seriesRuntime" placeholder="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesGenre">G√©neros (separados por coma)</label>
                        <input type="text" id="seriesGenre" placeholder="Drama, Suspenso, Crimen">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesDirector">Directores (separados por coma)</label>
                        <input type="text" id="seriesDirector" placeholder="Director 1, Director 2">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesCast">Reparto (separado por coma)</label>
                        <input type="text" id="seriesCast" placeholder="Actor 1, Actor 2, Actor 3">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesRating">Rating IMDB</label>
                        <input type="number" id="seriesRating" step="0.1" min="0" max="10" placeholder="8.5">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesPoster">URL del Poster</label>
                        <input type="url" id="seriesPoster" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesBackground">URL del Fondo</label>
                        <input type="url" id="seriesBackground" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="seriesLogo">URL del Logo</label>
                        <input type="url" id="seriesLogo" placeholder="https://...">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="seriesDescription">Descripci√≥n</label>
                        <textarea id="seriesDescription" placeholder="Descripci√≥n de la serie..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">‚ûï Agregar Serie</button>
            </form>

            <div id="seriesList" class="content-list">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- Tab: Episodios -->
        <div id="episodes" class="tab-content">
            <h2>üéûÔ∏è Gesti√≥n de Episodios</h2>
            
            <div id="episodeAlert" class="alert" style="display: none;"></div>
            
            <div class="series-selector">
                <label for="episodeSeriesSelect">Seleccionar Serie:</label>
                <select id="episodeSeriesSelect" required>
                    <option value="">Primero agrega una serie</option>
                </select>
            </div>
            
            <form id="episodeForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="episodeName">Nombre del Episodio *</label>
                        <input type="text" id="episodeName" placeholder="T√≠tulo del episodio" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeSeason">Temporada *</label>
                        <input type="number" id="episodeSeason" placeholder="1" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeNumber">N√∫mero de Episodio *</label>
                        <input type="number" id="episodeNumber" placeholder="1" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeYear">A√±o</label>
                        <input type="number" id="episodeYear" placeholder="2023" min="1900" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeRuntime">Duraci√≥n (min)</label>
                        <input type="number" id="episodeRuntime" placeholder="45">
                    </div>
                    
                    <div class="form-group">
                        <label for="episodePoster">URL del Thumbnail</label>
                        <input type="url" id="episodePoster" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeUrl">URL del Video *</label>
                        <input type="url" id="episodeUrl" placeholder="https://..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeQuality">Calidad</label>
                        <select id="episodeQuality">
                            <option value="">Seleccionar calidad</option>
                            <option value="HD">HD</option>
                            <option value="Full HD">Full HD</option>
                            <option value="4K">4K</option>
                            <option value="SD">SD</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="episodeLanguage">Idioma</label>
                        <input type="text" id="episodeLanguage" placeholder="Espa√±ol" value="Espa√±ol">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="episodeDescription">Descripci√≥n</label>
                        <textarea id="episodeDescription" placeholder="Descripci√≥n del episodio..."></textarea>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">‚ûï Agregar Episodio</button>
            </form>

            <div id="episodeList" class="content-list">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <p>‚è≥ Cargando...</p>
    </div>

    <script>
        // Variables globales
        let contentData = { movies: [], series: [], episodes: [] };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            updateAddonUrl();
            loadContent();
            setupEventListeners();
        });

        // Configurar URL del addon
        function updateAddonUrl() {
            const currentUrl = window.location.origin;
            document.getElementById('addonUrl').textContent = `${currentUrl}/manifest.json`;
        }

        // Event listeners
        function setupEventListeners() {
            // Formularios
            document.getElementById('movieForm').addEventListener('submit', handleMovieSubmit);
            document.getElementById('seriesForm').addEventListener('submit', handleSeriesSubmit);
            document.getElementById('episodeForm').addEventListener('submit', handleEpisodeSubmit);
        }

        // Gesti√≥n de tabs
        function showTab(tabName) {
            // Ocultar todas las tabs
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar tab seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Actualizar contenido si es necesario
            if (tabName === 'overview') {
                updateStats();
                displayRecentContent();
            } else if (tabName === 'episodes') {
                updateSeriesSelector();
            }
        }

        // Cargar contenido existente
        async function loadContent() {
            showLoading(true);
            try {
                const response = await fetch('/api/content');
                contentData = await response.json();
                
                updateStats();
                displayContent();
                updateSeriesSelector();
            } catch (error) {
                console.error('Error cargando contenido:', error);
                showAlert('error', 'Error al cargar el contenido', 'overview');
            }
            showLoading(false);
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('movieCount').textContent = contentData.movies.length;
            document.getElementById('seriesCount').textContent = contentData.series.length;
            document.getElementById('episodeCount').textContent = contentData.episodes.length;
        }

        // Mostrar contenido reciente
        function displayRecentContent() {
            const recentContainer = document.getElementById('recentContent');
            const allContent = [
                ...contentData.movies.map(m => ({...m, contentType: 'Pel√≠cula'})),
                ...contentData.series.map(s => ({...s, contentType: 'Serie'})),
                ...contentData.episodes.map(e => ({...e, contentType: 'Episodio', displayName: `${e.name} (T${e.season}E${e.episode})`}))
            ].slice(-5);
            
            if (allContent.length === 0) {
                recentContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay contenido agregado a√∫n</p>';
                return;
            }
            
            recentContainer.innerHTML = allContent.map(item => `
                <div class="content-item">
                    <div class="content-info">
                        <h4>${item.displayName || item.name}</h4>
                        <p>${item.contentType} ‚Ä¢ ${item.year || 'Sin a√±o'}</p>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Mostrar alertas
        function showAlert(type, message, tab = 'overview') {
            const alertId = tab === 'overview' ? 'overviewAlert' : `${tab}Alert`;
            const alertElement = document.getElementById(alertId);
            
            if (alertElement) {
                alertElement.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
                alertElement.textContent = message;
                alertElement.style.display = 'block';
                
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 5000);
            }
        }

        // Manejar env√≠o de pel√≠cula
        async function handleMovieSubmit(e) {
            e.preventDefault();
            
            const movieData = {
                id: document.getElementById('movieId').value,
                name: document.getElementById('movieName').value,
                year: document.getElementById('movieYear').value,
                runtime: document.getElementById('movieRuntime').value,
                genre: document.getElementById('movieGenre').value,
                director: document.getElementById('movieDirector').value,
                cast: document.getElementById('movieCast').value,
                imdbRating: document.getElementById('movieRating').value,
                poster: document.getElementById('moviePoster').value,
                background: document.getElementById('movieBackground').value,
                logo: document.getElementById('movieLogo').value,
                url: document.getElementById('movieUrl').value,
                quality: document.getElementById('movieQuality').value,
                language: document.getElementById('movieLanguage').value,
                description: document.getElementById('movieDescription').value
            };
            
            showLoading(true);
            try {
                const response = await fetch('/api/add-movie', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(movieData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message, 'movies');
                    document.getElementById('movieForm').reset();
                    document.getElementById('movieLanguage').value = 'Espa√±ol'; // Resetear idioma por defecto
                    loadContent();
                } else {
                    showAlert('error', result.error, 'movies');
                }
            } catch (error) {
                showAlert('error', 'Error al agregar pel√≠cula', 'movies');
            }
            showLoading(false);
        }

        // Manejar env√≠o de serie
        async function handleSeriesSubmit(e) {
            e.preventDefault();
            
            const seriesData = {
                id: document.getElementById('seriesId').value,
                name: document.getElementById('seriesName').value,
                year: document.getElementById('seriesYear').value,
                runtime: document.getElementById('seriesRuntime').value,
                genre: document.getElementById('seriesGenre').value,
                director: document.getElementById('seriesDirector').value,
                cast: document.getElementById('seriesCast').value,
                imdbRating: document.getElementById('seriesRating').value,
                poster: document.getElementById('seriesPoster').value,
                background: document.getElementById('seriesBackground').value,
                logo: document.getElementById('seriesLogo').value,
                description: document.getElementById('seriesDescription').value
            };
            
            showLoading(true);
            try {
                const response = await fetch('/api/add-series', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(seriesData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message, 'series');
                    document.getElementById('seriesForm').reset();
                    loadContent();
                } else {
                    showAlert('error', result.error, 'series');
                }
            } catch (error) {
                showAlert('error', 'Error al agregar serie', 'series');
            }
            showLoading(false);
        }

        // Manejar env√≠o de episodio
        async function handleEpisodeSubmit(e) {
            e.preventDefault();
            
            const seriesId = document.getElementById('episodeSeriesSelect').value;
            const season = document.getElementById('episodeSeason').value;
            const episode = document.getElementById('episodeNumber').value;
            
            if (!seriesId) {
                showAlert('error', 'Debes seleccionar una serie', 'episodes');
                return;
            }
            
            const episodeData = {
                seriesId: seriesId,
                name: document.getElementById('episodeName').value,
                season: parseInt(season),
                episode: parseInt(episode),
                year: document.getElementById('episodeYear').value,
                runtime: document.getElementById('episodeRuntime').value,
                poster: document.getElementById('episodePoster').value,
                url: document.getElementById('episodeUrl').value,
                quality: document.getElementById('episodeQuality').value,
                language: document.getElementById('episodeLanguage').value,
                description: document.getElementById('episodeDescription').value
            };
            
            console.log('Enviando episodio:', episodeData);
            
            showLoading(true);
            try {
                const response = await fetch('/api/add-episode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(episodeData)
                });
                
                const result = await response.json();
                console.log('Respuesta del servidor:', result);
                
                if (response.ok) {
                    showAlert('success', result.message, 'episodes');
                    document.getElementById('episodeForm').reset();
                    document.getElementById('episodeLanguage').value = 'Espa√±ol'; // Resetear idioma por defecto
                    loadContent();
                    
                    // Debug: verificar que el episodio se guard√≥
                    setTimeout(async () => {
                        try {
                            const debugResponse = await fetch(`/api/debug/series/${seriesId}/episodes`);
                            const debugData = await debugResponse.json();
                            console.log('Episodios de la serie despu√©s de agregar:', debugData);
                        } catch (error) {
                            console.error('Error en debug:', error);
                        }
                    }, 1000);
                } else {
                    showAlert('error', result.error, 'episodes');
                }
            } catch (error) {
                console.error('Error al agregar episodio:', error);
                showAlert('error', 'Error al agregar episodio', 'episodes');
            }
            showLoading(false);
        }

        // Actualizar selector de series
        function updateSeriesSelector() {
            const selector = document.getElementById('episodeSeriesSelect');
            
            if (contentData.series.length === 0) {
                selector.innerHTML = '<option value="">Primero agrega una serie</option>';
                return;
            }
            
            selector.innerHTML = '<option value="">Seleccionar serie...</option>' +
                contentData.series.map(series => 
                    `<option value="${series.id}">${series.name}</option>`
                ).join('');
        }

        // Mostrar contenido en las listas
        function displayContent() {
            displayMovies();
            displaySeries();
            displayEpisodes();
        }

        // Mostrar pel√≠culas
        function displayMovies() {
            const container = document.getElementById('movieList');
            
            if (contentData.movies.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay pel√≠culas agregadas</p>';
                return;
            }
            
            container.innerHTML = contentData.movies.map(movie => `
                <div class="content-item">
                    <div class="content-info">
                        <h4>${movie.name}</h4>
                        <p>${movie.year || 'Sin a√±o'} ‚Ä¢ ${movie.quality || 'Sin calidad'} ‚Ä¢ ${movie.language || 'Sin idioma'}</p>
                        <p><strong>ID:</strong> ${movie.id}</p>
                    </div>
                    <div class="content-actions">
                        <button class="btn btn-danger" onclick="deleteContent('movie', '${movie.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar series
        function displaySeries() {
            const container = document.getElementById('seriesList');
            
            if (contentData.series.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay series agregadas</p>';
                return;
            }
            
            container.innerHTML = contentData.series.map(series => {
                const episodeCount = contentData.episodes.filter(ep => ep.seriesId === series.id).length;
                return `
                    <div class="content-item">
                        <div class="content-info">
                            <h4>${series.name}</h4>
                            <p>${series.year || 'Sin a√±o'} ‚Ä¢ ${episodeCount} episodios</p>
                            <p><strong>ID:</strong> ${series.id}</p>
                        </div>
                        <div class="content-actions">
                            <button class="btn btn-danger" onclick="deleteContent('series', '${series.id}')">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mostrar episodios
        function displayEpisodes() {
            const container = document.getElementById('episodeList');
            
            if (contentData.episodes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay episodios agregados</p>';
                return;
            }
            
            // Agrupar episodios por serie
            const episodesBySeries = contentData.episodes.reduce((acc, episode) => {
                const seriesName = contentData.series.find(s => s.id === episode.seriesId)?.name || 'Serie desconocida';
                if (!acc[episode.seriesId]) {
                    acc[episode.seriesId] = { seriesName, episodes: [] };
                }
                acc[episode.seriesId].episodes.push(episode);
                return acc;
            }, {});
            
            container.innerHTML = Object.entries(episodesBySeries).map(([seriesId, data]) => `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">
                        üì∫ ${data.seriesName} 
                        <button onclick="debugSeries('${seriesId}')" style="margin-left: 10px; font-size: 12px; padding: 2px 6px;">üîç Debug</button>
                    </h3>
                    ${data.episodes.sort((a, b) => a.season - b.season || a.episode - b.episode).map(episode => `
                        <div class="content-item" style="margin-left: 20px;">
                            <div class="content-info">
                                <h4>T${episode.season}E${episode.episode} - ${episode.name}</h4>
                                <p>${episode.year || 'Sin a√±o'} ‚Ä¢ ${episode.quality || 'Sin calidad'} ‚Ä¢ ${episode.language || 'Sin idioma'}</p>
                                <p><strong>Duraci√≥n:</strong> ${episode.runtime || 'Sin especificar'} min</p>
                                <p><strong>URL:</strong> ${episode.url ? '‚úÖ Configurada' : '‚ùå Falta URL'}</p>
                                <p style="font-size: 12px; color: #666;"><strong>ID generado:</strong> ${episode.seriesId}:${episode.season}:${episode.episode}</p>
                            </div>
                            <div class="content-actions">
                                <button class="btn btn-danger" onclick="deleteEpisode('${episode.seriesId}', ${episode.season}, ${episode.episode})">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        // Funci√≥n de debug para series
        async function debugSeries(seriesId) {
            try {
                const response = await fetch(`/api/debug/meta/${seriesId}`);
                const data = await response.json();
                console.log('üîç Debug de serie:', data);
                alert(`Debug de serie:\n\nSerie: ${data.series.name}\nEpisodios: ${data.episodeCount}\nVideos generados: ${data.videos.length}\n\nRevisa la consola para m√°s detalles.`);
            } catch (error) {
                console.error('Error en debug:', error);
                alert('Error al obtener informaci√≥n de debug');
            }
        }

        // Eliminar contenido
        async function deleteContent(type, id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este contenido?')) {
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch(`/api/delete/${type}/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message, type === 'movie' ? 'movies' : 'series');
                    loadContent();
                } else {
                    showAlert('error', result.error, type === 'movie' ? 'movies' : 'series');
                }
            } catch (error) {
                showAlert('error', 'Error al eliminar contenido', type === 'movie' ? 'movies' : 'series');
            }
            showLoading(false);
        }

        // Eliminar episodio espec√≠fico
        async function deleteEpisode(seriesId, season, episode) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este episodio?')) {
                return;
            }
            
            showLoading(true);
            try {
                const episodeId = `${seriesId}:${season}:${episode}`;
                const response = await fetch(`/api/delete/episode/${episodeId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message, 'episodes');
                    loadContent();
                } else {
                    showAlert('error', result.error, 'episodes');
                }
            } catch (error) {
                showAlert('error', 'Error al eliminar episodio', 'episodes');
            }
            showLoading(false);
        }
    </script>
<!-- 

SOLUCI√ìN INTEGRADA CON LOGOS - COPIA ESTE SCRIPT COMPLETO Y P√âGALO ANTES DEL </body> EN TU HTML

Reemplaza TU_API_KEY_AQUI con tu API key de TMDB

-->

<script>
<script>
const TMDB_API_KEY='ed52d6c5a797006699cdcc63ed1208d5';
class TMDBClient{
constructor(){
this.apiKey=TMDB_API_KEY;
this.baseURL='https://api.themoviedb.org/3';
this.imageBaseURL='https://image.tmdb.org/t/p/w500';
this.backdropBaseURL='https://image.tmdb.org/t/p/w1280';
this.logoBaseURL='https://image.tmdb.org/t/p/original';
}

// Nueva funci√≥n para buscar por nombre
async searchByName(query, type = 'multi') {
if(!this.apiKey||this.apiKey==='TU_API_KEY_AQUI') throw new Error('API Key de TMDB no configurada');

const endpoint = type === 'multi' ? 'search/multi' : `search/${type}`;
const response = await fetch(`${this.baseURL}/${endpoint}?api_key=${this.apiKey}&query=${encodeURIComponent(query)}&language=es-MX&include_adult=false`);
    
if(!response.ok){
if(response.status===401) throw new Error('API Key inv√°lida');
throw new Error(`Error HTTP: ${response.status}`);
}
    
const data = await response.json();
return data.results || [];
}

// Nueva funci√≥n para obtener ID de IMDB desde detalles
async getIMDBId(type, tmdbId) {
try {
const endpoint = type === 'movie' ? 'movie' : 'tv';
const response = await fetch(`${this.baseURL}/${endpoint}/${tmdbId}/external_ids?api_key=${this.apiKey}`);
if(!response.ok) return null;
const data = await response.json();
return data.imdb_id || null;
} catch {
return null;
}
}

async searchByIMDB(imdbId){
if(!this.apiKey||this.apiKey==='TU_API_KEY_AQUI') throw new Error('API Key de TMDB no configurada');
const response=await fetch(`${this.baseURL}/find/${imdbId}?api_key=${this.apiKey}&external_source=imdb_id&language=es-MX`);
if(!response.ok){
if(response.status===401) throw new Error('API Key inv√°lida');
if(response.status===404) throw new Error('No se encontr√≥ contenido con ese ID');
throw new Error(`Error HTTP: ${response.status}`);
}
const data=await response.json();
if(data.movie_results?.length>0) return await this.getMovieDetails(data.movie_results[0].id);
if(data.tv_results?.length>0) return await this.getTVDetails(data.tv_results[0].id);
throw new Error('No se encontr√≥ contenido con ese ID');
}

async getImages(type,id){
try{
const response=await fetch(`${this.baseURL}/${type}/${id}/images?api_key=${this.apiKey}`);
if(!response.ok) return null;
const images=await response.json();
if(!images.logos?.length) return null;
const logo=images.logos.find(l=>l.iso_639_1==='en')||images.logos.find(l=>!l.iso_639_1)||images.logos[0];
return logo?`${this.logoBaseURL}${logo.file_path}`:null;
}catch{return null;}
}

async getMovieDetails(movieId){
const response=await fetch(`${this.baseURL}/movie/${movieId}?api_key=${this.apiKey}&language=es-MX&append_to_response=credits`);
if(!response.ok) throw new Error(`Error obteniendo detalles: ${response.status}`);
const movie=await response.json();
const logo=await this.getImages('movie',movieId);
const imdbId = await this.getIMDBId('movie', movieId);
return{
type:'movie',
name:movie.title,
year:movie.release_date?new Date(movie.release_date).getFullYear():null,
runtime:movie.runtime,
genre:movie.genres.map(g=>g.name).join(', '),
director:movie.credits.crew.filter(p=>p.job==='Director').map(p=>p.name).join(', '),
cast:movie.credits.cast.slice(0,5).map(p=>p.name).join(', '),
imdbRating:movie.vote_average,
poster:movie.poster_path?`${this.imageBaseURL}${movie.poster_path}`:'',
background:movie.backdrop_path?`${this.backdropBaseURL}${movie.backdrop_path}`:'',
logo:logo||'',
description:movie.overview,
imdbId: imdbId
};
}

async getTVDetails(tvId){
const response=await fetch(`${this.baseURL}/tv/${tvId}?api_key=${this.apiKey}&language=es-MX&append_to_response=credits`);
if(!response.ok) throw new Error(`Error obteniendo detalles: ${response.status}`);
const tv=await response.json();
const logo=await this.getImages('tv',tvId);
const imdbId = await this.getIMDBId('tv', tvId);
return{
type:'tv',
name:tv.name,
year:tv.first_air_date?new Date(tv.first_air_date).getFullYear():null,
runtime:tv.episode_run_time?.length>0?tv.episode_run_time[0]:null,
genre:tv.genres.map(g=>g.name).join(', '),
director:tv.created_by.map(p=>p.name).join(', '),
cast:tv.credits.cast.slice(0,5).map(p=>p.name).join(', '),
imdbRating:tv.vote_average,
poster:tv.poster_path?`${this.imageBaseURL}${tv.poster_path}`:'',
background:tv.backdrop_path?`${this.backdropBaseURL}${tv.backdrop_path}`:'',
logo:logo||'',
description:tv.overview,
imdbId: imdbId
};
}
}

const tmdbClient=new TMDBClient();

function showMessage(message,type='info'){
const existing=document.querySelector('.tmdb-message');
if(existing) existing.remove();
const messageDiv=document.createElement('div');
messageDiv.className='tmdb-message';
messageDiv.textContent=message;
const colors={success:'#d4edda',error:'#f8d7da',warning:'#fff3cd',info:'#d1ecf1'};
messageDiv.style.cssText=`position:fixed;top:20px;right:20px;background:${colors[type]};padding:10px 15px;border-radius:5px;border-left:4px solid ${type==='success'?'#28a745':type==='error'?'#dc3545':'#17a2b8'};z-index:10000;font-size:14px;max-width:300px;box-shadow:0 2px 10px rgba(0,0,0,0.1)`;
document.body.appendChild(messageDiv);
setTimeout(()=>messageDiv.remove(),4000);
}

function fillField(fieldId,value){
const field=document.getElementById(fieldId);
if(field&&!field.value&&value){
field.value=value;
field.style.backgroundColor='#d4edda';
setTimeout(()=>field.style.backgroundColor='',1000);
}
}

// Nueva funci√≥n para mostrar selector de resultados
function showResultSelector(results, type, inputField) {
// Remover selector existente si hay uno
const existing = document.querySelector('.tmdb-selector');
if(existing) existing.remove();

const selector = document.createElement('div');
selector.className = 'tmdb-selector';
selector.style.cssText = `
position: absolute;
background: white;
border: 1px solid #ccc;
border-radius: 4px;
box-shadow: 0 2px 10px rgba(0,0,0,0.1);
max-height: 200px;
overflow-y: auto;
z-index: 1000;
width: 100%;
margin-top: 2px;
`;

results.forEach((result, index) => {
const option = document.createElement('div');
option.style.cssText = `
padding: 10px;
cursor: pointer;
border-bottom: 1px solid #eee;
display: flex;
align-items: center;
`;
option.addEventListener('mouseenter', () => option.style.backgroundColor = '#f5f5f5');
option.addEventListener('mouseleave', () => option.style.backgroundColor = '');

const img = document.createElement('img');
img.src = result.poster_path ? `${tmdbClient.imageBaseURL}${result.poster_path}` : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="60" fill="%23ccc"><rect width="40" height="60" fill="%23f0f0f0"/><text x="20" y="35" text-anchor="middle" fill="%23999" font-size="10">Sin imagen</text></svg>';
img.style.cssText = 'width: 40px; height: 60px; margin-right: 10px; object-fit: cover; border-radius: 2px;';
img.onerror = () => img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="60" fill="%23ccc"><rect width="40" height="60" fill="%23f0f0f0"/><text x="20" y="35" text-anchor="middle" fill="%23999" font-size="10">Sin imagen</text></svg>';

const info = document.createElement('div');
const title = result.title || result.name;
const year = result.release_date ? new Date(result.release_date).getFullYear() : 
             result.first_air_date ? new Date(result.first_air_date).getFullYear() : '';
const mediaType = result.media_type === 'movie' ? 'üé¨' : result.media_type === 'tv' ? 'üì∫' : 'üé≠';
    
info.innerHTML = `
<div style="font-weight: bold; color: #333;">${mediaType} ${title}</div>
<div style="font-size: 12px; color: #666;">${year ? `(${year})` : 'A√±o desconocido'}</div>
<div style="font-size: 11px; color: #999;">Rating: ${result.vote_average?.toFixed(1) || 'N/A'}/10</div>
`;

option.appendChild(img);
option.appendChild(info);

option.addEventListener('click', async () => {
selector.remove();
const resultType = result.media_type || (type === 'pel√≠cula' ? 'movie' : 'tv');
await processSelectedResult(result, resultType, type, inputField);
});

selector.appendChild(option);
});

// Agregar opci√≥n para cerrar
const closeOption = document.createElement('div');
closeOption.style.cssText = `
padding: 8px;
text-align: center;
color: #666;
font-size: 12px;
cursor: pointer;
border-top: 2px solid #eee;
background: #f9f9f9;
`;
closeOption.textContent = 'Cerrar (ESC)';
closeOption.addEventListener('click', () => selector.remove());
selector.appendChild(closeOption);

// Posicionar el selector
inputField.parentElement.style.position = 'relative';
inputField.parentElement.appendChild(selector);

// Cerrar con ESC
document.addEventListener('keydown', function escHandler(e) {
if(e.key === 'Escape') {
selector.remove();
document.removeEventListener('keydown', escHandler);
}
});
}

async function processSelectedResult(result, resultType, expectedType, inputField) {
try {
showMessage(`Obteniendo detalles completos...`, 'info');
        
let data;
if(resultType === 'movie') {
data = await tmdbClient.getMovieDetails(result.id);
} else {
data = await tmdbClient.getTVDetails(result.id);
}

// Verificar que el tipo coincida
if((expectedType === 'pel√≠cula' && data.type !== 'movie') || 
   (expectedType === 'serie' && data.type !== 'tv')) {
showMessage(`Seleccionaste ${data.type === 'movie' ? 'una pel√≠cula' : 'una serie'}, pero el campo es para ${expectedType}`, 'error');
return;
}

// Llenar el campo ID con el IMDB ID si est√° disponible
if(data.imdbId && inputField) {
inputField.value = data.imdbId;
inputField.style.backgroundColor = '#d4edda';
setTimeout(() => inputField.style.backgroundColor = '', 1000);
}

// Autocompletar los dem√°s campos
const prefix = expectedType === 'pel√≠cula' ? 'movie' : 'series';
fillField(`${prefix}Name`, data.name);
fillField(`${prefix}Year`, data.year);
fillField(`${prefix}Runtime`, data.runtime);
fillField(`${prefix}Genre`, data.genre);
fillField(`${prefix}Director`, data.director);
fillField(`${prefix}Cast`, data.cast);
fillField(`${prefix}Rating`, data.imdbRating?.toFixed(1));
fillField(`${prefix}Poster`, data.poster);
fillField(`${prefix}Background`, data.background);
fillField(`${prefix}Logo`, data.logo);
fillField(`${prefix}Description`, data.description);

showMessage(`Informaci√≥n de ${expectedType} cargada${data.logo ? ' (con logo)' : ' (sin logo)'}${data.imdbId ? ` - ID: ${data.imdbId}` : ''}`, data.logo ? 'success' : 'warning');

} catch(error) {
showMessage(`Error: ${error.message}`, 'error');
}
}

async function autoFill(input, type) {
const value = input.trim();
if(!value) return;

try {
// Si es un ID de IMDB, usar la funci√≥n original
if(value.startsWith('tt')) {
showMessage(`Buscando informaci√≥n de ${type} por ID IMDB...`, 'info');
const data = await tmdbClient.searchByIMDB(value);
            
if(data.type !== (type === 'pel√≠cula' ? 'movie' : 'tv')) {
showMessage(`El ID corresponde a ${data.type === 'movie' ? 'una pel√≠cula' : 'una serie'}, no a ${type}`, 'error');
return;
}
            
const prefix = type === 'pel√≠cula' ? 'movie' : 'series';
fillField(`${prefix}Name`, data.name);
fillField(`${prefix}Year`, data.year);
fillField(`${prefix}Runtime`, data.runtime);
fillField(`${prefix}Genre`, data.genre);
fillField(`${prefix}Director`, data.director);
fillField(`${prefix}Cast`, data.cast);
fillField(`${prefix}Rating`, data.imdbRating?.toFixed(1));
fillField(`${prefix}Poster`, data.poster);
fillField(`${prefix}Background`, data.background);
fillField(`${prefix}Logo`, data.logo);
fillField(`${prefix}Description`, data.description);
            
showMessage(`Informaci√≥n de ${type} cargada${data.logo ? ' (con logo)' : ' (sin logo)'}`, data.logo ? 'success' : 'warning');
} else {
// Si no es un ID de IMDB, buscar por nombre
showMessage(`Buscando "${value}"...`, 'info');
const searchType = type === 'pel√≠cula' ? 'movie' : 'tv';
const results = await tmdbClient.searchByName(value, searchType);
            
if(results.length === 0) {
showMessage(`No se encontraron resultados para "${value}"`, 'warning');
return;
}
            
// Si hay m√∫ltiples resultados, mostrar selector
if(results.length > 1) {
showMessage(`Se encontraron ${results.length} resultados. Selecciona uno:`, 'info');
const inputField = type === 'pel√≠cula' ? document.getElementById('movieId') : document.getElementById('seriesId');
showResultSelector(results, type, inputField);
} else {
// Si hay solo un resultado, procesarlo directamente
const result = results[0];
const resultType = result.media_type || searchType;
const inputField = type === 'pel√≠cula' ? document.getElementById('movieId') : document.getElementById('seriesId');
await processSelectedResult(result, resultType, type, inputField);
}
}
} catch(error) {
showMessage(error.message, 'error');
}
}

document.addEventListener('DOMContentLoaded', function(){
const movieIdInput = document.getElementById('movieId');
const seriesIdInput = document.getElementById('seriesId');

function createButton(text, onClick) {
const btn = document.createElement('button');
btn.type = 'button';
btn.textContent = text;
btn.style.cssText = 'margin-top:8px;padding:8px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px';
btn.onclick = onClick;
return btn;
}

if(movieIdInput) {
const movieBtn = createButton('üîÑ Autocompletar desde TMDB', () => autoFill(movieIdInput.value.trim(), 'pel√≠cula'));
movieIdInput.parentElement.appendChild(movieBtn);
movieIdInput.addEventListener('blur', () => movieIdInput.value.trim() && autoFill(movieIdInput.value.trim(), 'pel√≠cula'));
        
// Agregar placeholder explicativo
movieIdInput.placeholder = 'ID IMDB (tt1234567) o nombre de la pel√≠cula';
}

if(seriesIdInput) {
const seriesBtn = createButton('üîÑ Autocompletar desde TMDB', () => autoFill(seriesIdInput.value.trim(), 'serie'));
seriesIdInput.parentElement.appendChild(seriesBtn);
seriesIdInput.addEventListener('blur', () => seriesIdInput.value.trim() && autoFill(seriesIdInput.value.trim(), 'serie'));
        
// Agregar placeholder explicativo
seriesIdInput.placeholder = 'ID IMDB (tt1234567) o nombre de la serie';
}

window.testTMDB = async function(query = 'Simpsons') {
try {
console.log('Buscando:', query);
if(query.startsWith('tt')) {
const result = await tmdbClient.searchByIMDB(query);
console.log('Resultado por IMDB:', result);
return result;
} else {
const results = await tmdbClient.searchByName(query);
console.log('Resultados por nombre:', results);
return results;
}
} catch(error) {
console.error('Error:', error);
throw error;
}
};
});
</script>
</body>
</html>
